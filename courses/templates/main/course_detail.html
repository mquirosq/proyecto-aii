{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.title }} — Curio{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/course_detail.css' %}">
<div class="container my-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="row align-items-start">
                <div class="col-lg-8">
                    <h2 class="card-title mb-1">{{ course.title }}</h2>
                    <p class="text-muted small mb-2">Plataforma: <span class="fw-semibold">{{ course.platform.name }}</span></p>

                    <div class="mb-3">
                        {% if course.category %}<span class="badge bg-info text-dark me-1"><i class="bi bi-tags-fill"></i> {{ course.category.name }}</span>{% endif %}
                        {% if course.level %}<span class="badge bg-secondary me-1"><i class="bi bi-bar-chart-fill"></i> {{ course.get_level_display }}</span>{% endif %}
                        {% if course.duration %}<span class="badge bg-light text-dark"><i class="bi bi-clock"></i> {{ course.duration }} h</span>{% endif %}
                    </div>

                    <p class="mb-3">{% if course.description %}{{ course.description }}{% else %}<em>Sin descripción disponible.</em>{% endif %}</p>

                    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
                        {% if user.is_authenticated %}
                        <form method="post" action="{% url 'toggle_feedback' course.id 'like' %}" class="d-inline" data-action="like">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm {% if course.is_liked %}btn-success{% else %}btn-outline-secondary{% endif %}" title="Me gusta">
                                <i class="bi bi-hand-thumbs-up-fill"></i>
                            </button>
                        </form>

                        <form method="post" action="{% url 'toggle_feedback' course.id 'dislike' %}" class="d-inline" data-action="dislike">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm {% if course.is_disliked %}btn-danger{% else %}btn-outline-secondary{% endif %}" title="No me gusta">
                                <i class="bi bi-hand-thumbs-down-fill"></i>
                            </button>
                        </form>
                        {% endif %}

                        <a href="{{ course.url }}" class="btn btn-primary btn-sm" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right"></i> Ir al curso</a>
                        <a href="{% url 'all_courses' %}" class="btn btn-outline-secondary btn-sm">Volver a la lista</a>
                    </div>

                    {% if course.rating %}
                    <div class="mb-2 d-flex align-items-center">
                        <strong class="me-2">Valoración:</strong>
                        <div class="rating" aria-label="Valoración: {{ course.rating }}/5">
                            {% for _ in "12345"|make_list %}
                                {% if forloop.counter <= course.rating %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                {% else %}
                                    <i class="bi bi-star text-muted"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="ms-2 small text-muted">({{ course.rating }}/5)</span>
                    </div>
                    {% endif %}

                    {% if user.is_authenticated %}
                        <div id="course-detail" data-mark-viewed-url="{% url 'mark_course_viewed' course.id %}" style="display:none"></div>
                    {% endif %}

                </div>

                <div class="col-lg-4 mt-3 mt-lg-0">
                    <div class="card border-0">
                        <div class="card-body p-3">
                            <p class="mb-1 small text-muted"><strong>Última extracción</strong><br>{{ course.last_scraped }}</p>
                            <p class="mb-2 small text-muted"><strong>URL</strong><br><a href="{{ course.url }}" target="_blank" rel="noopener" class="text-truncate d-inline-block" style="max-width:100%;">{{ course.url }}</a></p>
                            {% if course.instructor %}
                                <p class="mb-0 small text-muted"><strong>Instructor</strong><br>{{ course.instructor.name }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if similar_courses %}
<div class="container my-4">
    <h5>Cursos similares</h5>
    <div class="row">
        {% for s in similar_courses %}
            <div class="col-12 col-sm-6 col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title d-flex justify-content-between align-items-start">
                            <a href="{% url 'course_detail' s.id %}">{{ s.title }}</a>
                            {% if s.rank %}
                                <span class="badge bg-primary top-pill ms-2">Top {{ s.rank }}</span>
                            {% endif %}
                        </h6>
                        <p class="small text-muted mb-1">{{ s.platform.name }}{% if s.instructor %} — {{ s.instructor.name }}{% endif %}</p>
                        <p class="small text-muted mb-1">Duración: {% if s.duration %}{{ s.duration }} h{% else %}—{% endif %}</p>
                        {% if s.level %}
                            <p class="small text-muted mb-1">Nivel: {{ s.get_level_display }}</p>
                        {% endif %}
                        {% if s.match_reasons %}
                            <p class="small text-muted mb-0">Razones: {{ s.match_reasons }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if next_courses %}
<div class="container my-4">
    <h5>Siguientes pasos</h5>
    <div class="row">
        {% for n in next_courses %}
            <div class="col-12 col-sm-6 col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title d-flex justify-content-between align-items-start">
                            <a href="{% url 'course_detail' n.id %}">{{ n.title }}</a>
                            {% if n.rank %}
                                <span class="badge bg-primary top-pill ms-2">Top {{ n.rank }}</span>
                            {% endif %}
                        </h6>
                        <p class="small text-muted mb-1">{{ n.platform.name }}{% if n.instructor %} — {{ n.instructor.name }}{% endif %}</p>
                        <p class="small text-muted mb-1">Duración: {% if n.duration %}{{ n.duration }} h{% else %}—{% endif %}</p>
                        <p class="small text-muted mb-1">Nivel: {{ n.get_level_display }}</p>
                        {% if n.match_reasons %}
                            <p class="small text-muted mb-0">Razones: {{ n.match_reasons }}</p>
                        {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

{% if user.is_authenticated %}
    <script src="{% static 'js/course_detail_viewed.js' %}"></script>
{% endif %}

{% endblock %}
