{% extends 'base.html' %}
{% load static %}

{% block content %}
<main class="container py-4">

    <h1 class="mb-4">Todos los cursos</h1>
    <link rel="stylesheet" href="{% static 'css/all_courses.css' %}">

    <form method="get" class="row g-2 mb-3 filters-card p-3 align-items-center">
        <div class="col-12 col-md-6">
            <div class="input-group">
                <span class="input-group-text" id="search-icon" style="background:transparent;border:none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--bs-body-color);">
                        <circle cx="11" cy="11" r="7"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </span>
                <input type="search" name="q" value="{{ query }}" class="form-control form-control-sm" placeholder="Buscar por título o descripción" aria-describedby="search-icon">
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="input-group">
                <span class="input-group-text" id="order-icon" title="Ordenar" style="background:transparent;border:none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--bs-body-color);">
                        <!-- Up arrow (top) -->
                        <polyline points="6 9 12 3 18 9"></polyline>
                        <!-- Down arrow (bottom) -->
                        <polyline points="6 15 12 21 18 15"></polyline>
                    </svg>
                </span>
                <select id="order-select" name="order" class="form-select form-select-sm" aria-describedby="order-icon">
                    {% for val,label in orders %}
                    <option value="{{ val }}" {% if val == selected_order %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="w-100"></div>
        
        <div class="filters-row mt-2">
            <div class="filter-item">
                <select name="platform" class="form-select form-select-sm">
                    <option value="">Plataforma</option>
                    {% for plat in platforms %}
                    <option value="{{ plat.id }}" {% if plat.id|stringformat:"s" == selected_platform %}selected{% endif %}>{{ plat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-item">
                <select name="category" class="form-select form-select-sm">
                    <option value="">Categoría</option>
                    <option value="none" {% if selected_category == 'none' %}selected{% endif %}>Sin categoría</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if cat.id|stringformat:"s" == selected_category %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-item">
                <select name="level" class="form-select form-select-sm">
                    <option value="">Nivel</option>
                    {% for lv in levels %}
                    <option value="{{ lv }}" {% if lv == selected_level %}selected{% endif %}>{{ lv }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-item">
                <select name="instructor" class="form-select form-select-sm">
                    <option value="">Instructor</option>
                    <option value="none" {% if selected_instructor == 'none' %}selected{% endif %}>Sin instructor</option>
                    {% for instr in instructors %}
                    <option value="{{ instr.id }}" {% if instr.id|stringformat:"s" == selected_instructor %}selected{% endif %}>{{ instr.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-item">
                <select name="duration" class="form-select form-select-sm">
                    <option value="" {% if selected_duration == '' %}selected{% endif %}>Duración</option>
                    <option value="<5" {% if selected_duration == '<5' %}selected{% endif %}>&lt;5 h</option>
                    <option value="5-10" {% if selected_duration == '5-10' %}selected{% endif %}>5-10 h</option>
                    <option value="10-50" {% if selected_duration == '10-50' %}selected{% endif %}>10-50 h</option>
                    <option value=">50" {% if selected_duration == '>50' %}selected{% endif %}>&gt;50 h</option>
                </select>
            </div>

            <div class="filter-item">
                <select name="rating" class="form-select form-select-sm">
                    {% for val,label in ratings %}
                    <option value="{{ val }}" {% if val == selected_rating %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-action">
                <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
            </div>
        </div>
    </form>

    {% if courses and courses.object_list %}
    <div class="row">
        {% for course in courses %}
        <div class="col-12">
            <div class="card mb-3 course-card">
                <div class="card-body d-md-flex justify-content-between align-items-center">
                    <div class="me-3 flex-grow-1">
                        <h5 class="card-title mb-1">{{ course.title }}</h5>
                        <div class="mb-2 meta">
                            <span class="badge badge-muted me-1">{{ course.platform }}</span>
                            {% if course.level %}<span class="badge bg-secondary me-1">{{ course.level }}</span>{% endif %}
                            {% if course.duration %}<span class="badge badge-duration me-1">{{ course.duration }}h</span>{% endif %}
                            {% if course.rating %}
                            <span class="badge bg-warning text-dark">★ {{ course.rating|floatformat:1 }}</span>
                            {% endif %}
                            {% if course.search_score %}
                            <span class="badge badge-score me-1">Score {{ course.search_score|floatformat:2 }}</span>
                            {% endif %}
                        </div>
                        <p class="card-text course-desc mb-2">{{ course.description|truncatechars:220 }}</p>
                        <div>
                            {% if course.instructor %}<small class="text-muted">Instructor: {{ course.instructor }}</small>{% endif %}
                        </div>
                    </div>
                    <div class="text-md-end mt-3 mt-md-0">
                        <div class="d-flex flex-column align-items-end gap-2 mb-2">
                            {% if user.is_authenticated %}
                            <div class="d-flex gap-2">
                                <form method="post"
                                    action="{% url 'toggle_feedback' course.id 'like' %}"
                                    class="ajax-feedback"
                                    data-action="like">
                                    {% csrf_token %}
                                    <button type="button" onclick="handleFeedback(this)"
                                            class="btn btn-sm ajax-feedback-btn
                                            {% if course.is_liked %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                            aria-pressed="{% if course.is_liked %}true{% else %}false{% endif %}">
                                        <i class="bi bi-hand-thumbs-up-fill"></i>
                                    </button>
                                </form>

                                <form method="post"
                                    action="{% url 'toggle_feedback' course.id 'dislike' %}"
                                    class="ajax-feedback"
                                    data-action="dislike">
                                    {% csrf_token %}
                                    <button type="button" onclick="handleFeedback(this)"
                                            class="btn btn-sm ajax-feedback-btn
                                            {% if course.is_disliked %}btn-danger{% else %}btn-outline-secondary{% endif %}"
                                            aria-pressed="{% if course.is_disliked %}true{% else %}false{% endif %}">
                                        <i class="bi bi-hand-thumbs-down-fill"></i>
                                    </button>
                                </form>
                            </div>
                            {% endif %}

                            <div class="d-flex flex-column flex-md-row align-items-center justify-content-end gap-2">
                                <a href="{{ course.url }}" class="btn btn-sm btn-primary mb-2 mb-md-0" target="_blank" rel="noopener">Ir al curso</a>
                                <a href="{% url 'course_detail' course.id %}" class="btn btn-sm btn-outline-secondary">Ver detalle</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No hay cursos disponibles.</p>
    {% endif %}

    {% if paginator and paginator.num_pages > 1 %}
        <nav aria-label="Pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                {% if courses.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% if query %}q={{ query }}&amp;{% endif %}{% if selected_platform %}platform={{ selected_platform }}&amp;{% endif %}{% if selected_category %}category={{ selected_category }}&amp;{% endif %}{% if selected_level %}level={{ selected_level }}&amp;{% endif %}{% if selected_instructor %}instructor={{ selected_instructor }}&amp;{% endif %}{% if selected_duration %}duration={{ selected_duration }}&amp;{% endif %}{% if selected_rating %}rating={{ selected_rating }}&amp;{% endif %}{% if selected_order %}order={{ selected_order }}&amp;{% endif %}page={{ courses.previous_page_number }}">Anterior</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                {% endif %}

                {% if page_numbers %}
                    {% if 1 not in page_numbers %}
                        <li class="page-item"><a class="page-link" href="?{% if query %}q={{ query }}&amp;{% endif %}{% if selected_platform %}platform={{ selected_platform }}&amp;{% endif %}{% if selected_category %}category={{ selected_category }}&amp;{% endif %}{% if selected_level %}level={{ selected_level }}&amp;{% endif %}{% if selected_instructor %}instructor={{ selected_instructor }}&amp;{% endif %}{% if selected_duration %}duration={{ selected_duration }}&amp;{% endif %}{% if selected_rating %}rating={{ selected_rating }}&amp;{% endif %}{% if selected_order %}order={{ selected_order }}&amp;{% endif %}page=1">1</a></li>
                        {% if page_numbers.0 > 2 %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        {% endif %}
                    {% endif %}

                    {% for num in page_numbers %}
                        <li class="page-item {% if num == courses.number %}active{% endif %}">
                            <a class="page-link" href="?{% if query %}q={{ query }}&amp;{% endif %}{% if selected_platform %}platform={{ selected_platform }}&amp;{% endif %}{% if selected_category %}category={{ selected_category }}&amp;{% endif %}{% if selected_level %}level={{ selected_level }}&amp;{% endif %}{% if selected_instructor %}instructor={{ selected_instructor }}&amp;{% endif %}{% if selected_duration %}duration={{ selected_duration }}&amp;{% endif %}{% if selected_rating %}rating={{ selected_rating }}&amp;{% endif %}{% if selected_order %}order={{ selected_order }}&amp;{% endif %}page={{ num }}">{{ num }}</a>
                        </li>
                    {% endfor %}

                    {% if paginator.num_pages not in page_numbers %}
                        {% if paginator.num_pages|add:"-1" not in page_numbers %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        {% endif %}
                        <li class="page-item"><a class="page-link" href="?{% if query %}q={{ query }}&amp;{% endif %}{% if selected_platform %}platform={{ selected_platform }}&amp;{% endif %}{% if selected_category %}category={{ selected_category }}&amp;{% endif %}{% if selected_level %}level={{ selected_level }}&amp;{% endif %}{% if selected_instructor %}instructor={{ selected_instructor }}&amp;{% endif %}{% if selected_duration %}duration={{ selected_duration }}&amp;{% endif %}{% if selected_rating %}rating={{ selected_rating }}&amp;{% endif %}{% if selected_order %}order={{ selected_order }}&amp;{% endif %}page={{ paginator.num_pages }}">{{ paginator.num_pages }}</a></li>
                    {% endif %}
                {% endif %}

                {% if courses.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% if query %}q={{ query }}&amp;{% endif %}{% if selected_platform %}platform={{ selected_platform }}&amp;{% endif %}{% if selected_category %}category={{ selected_category }}&amp;{% endif %}{% if selected_level %}level={{ selected_level }}&amp;{% endif %}{% if selected_instructor %}instructor={{ selected_instructor }}&amp;{% endif %}{% if selected_duration %}duration={{ selected_duration }}&amp;{% endif %}{% if selected_rating %}rating={{ selected_rating }}&amp;{% endif %}{% if selected_order %}order={{ selected_order }}&amp;{% endif %}page={{ courses.next_page_number }}">Siguiente</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
                {% endif %}
            </ul>
        </nav>
        <div class="text-center text-muted mt-2">Página {{ courses.number }} de {{ paginator.num_pages }}</div>
    {% endif %}

</main>
</main>
<script src="{% static 'js/all_courses.js' %}"></script>
{% endblock %}
            <li class="page-item">
